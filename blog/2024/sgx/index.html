<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Intel SGX Software Stack | Kha Dinh Duy</title> <meta name="author" content="Kha Dinh Duy"> <meta name="description" content="Notes on SGX Software Stack"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8E%AE&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://kha-dinh.github.io/blog/2024/sgx/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <title>Intel SGX Software Stack | blank</title> <meta name="generator" content="Jekyll v4.3.4"> <meta property="og:title" content="Intel SGX Software Stack"> <meta property="og:locale" content="en"> <meta name="description" content="Notes on SGX Software Stack"> <meta property="og:description" content="Notes on SGX Software Stack"> <link rel="canonical" href="https://kha-dinh.github.io/blog/2024/sgx/"> <meta property="og:url" content="https://kha-dinh.github.io/blog/2024/sgx/"> <meta property="og:site_name" content="blank"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2024-12-26T14:22:00+00:00"> <meta name="twitter:card" content="summary"> <meta property="twitter:title" content="Intel SGX Software Stack"> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-12-26T14:22:00+00:00","datePublished":"2024-12-26T14:22:00+00:00","description":"Notes on SGX Software Stack","headline":"Intel SGX Software Stack","mainEntityOfPage":{"@type":"WebPage","@id":"https://kha-dinh.github.io/blog/2024/sgx/"},"url":"https://kha-dinh.github.io/blog/2024/sgx/"}</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Kha </span>Dinh Duy</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Intel SGX Software Stack</h1> <p class="post-meta">December 26, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/sgx"> <i class="fa-solid fa-hashtag fa-sm"></i> sgx</a>     ·   <a href="/blog/category/blog"> <i class="fa-solid fa-tag fa-sm"></i> blog</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>The software stack for developing and launching Intel SGX enclaves is such a mess. Parts of this is due to confusing naming, and lack of centralized documentations. This post the process of me trying make sense of it from a developer point of view.</p> <h2 id="the-software-stack">The software stack</h2> <p>There are awfully lots of moving parts involved in launching an SGX enclave.</p> <ul> <li>The <strong>SGX Driver</strong> allows interaction with SGX hardware components. The driver uses privileged instruction for enclave management (e.g., <code class="language-plaintext highlighter-rouge">ECREATE</code>, <code class="language-plaintext highlighter-rouge">EADD</code>, <code class="language-plaintext highlighter-rouge">EEXTEND</code>). Three endpoints are exposed to the userspace, which are communicated with through IOCTL APIs. <ul> <li> <code class="language-plaintext highlighter-rouge">/dev/sgx_enclave</code> provides APIs for enclave management (<a href="https://www.kernel.org/doc/html/next/x86/sgx.html" rel="external nofollow noopener" target="_blank">2</a>). Some of the APIs: <ul> <li> <code class="language-plaintext highlighter-rouge">SGX_IOC_ENCLAVE_CREATE</code> allocates kernel structures and invokes <code class="language-plaintext highlighter-rouge">ECREATE</code> to create an enclave.</li> <li> <code class="language-plaintext highlighter-rouge">SGX_IOC_ENCLAVE_ADD_PAGES</code> add pages to uninitialized enclaves and also optionally extends its measurement.</li> <li> <code class="language-plaintext highlighter-rouge">SGX_IOC_ENCLAVE_INIT</code> finalize enclave initialization.</li> </ul> </li> <li> <code class="language-plaintext highlighter-rouge">/dev/sgx_provision</code>: Not sure what it does currently, probably related to secret provisioning.</li> <li> <code class="language-plaintext highlighter-rouge">/dev/sgx_vepc</code> (the virtual EPC) support launching SGX enclave in guest virtual machines.</li> </ul> </li> <li> <strong>Intel PSW (Platform SoftWare)</strong> is the userspace component in charge of launching enclaves and provide runtime services (key provisioning, remote attestation). <ul> <li> <strong>AESM (Architectural Enclave Service Manager)</strong> service is maintained as a single binary installed at <code class="language-plaintext highlighter-rouge">opt/intel/sgxpsw/aesm/aesm_service</code> that is launched by <code class="language-plaintext highlighter-rouge">systemd</code> (<a href="https://community.intel.com/t5/Intel-Software-Guard-Extensions/what-difference-on-sgx-psw-and-sgx-sdk/m-p/1134047#M1997" rel="external nofollow noopener" target="_blank">1</a>).</li> <li>AESM perform the task of launching <strong>architectural enclaves</strong> (<a href="https://gramine.readthedocs.io/en/stable/sgx-intro.html" rel="external nofollow noopener" target="_blank">3</a>) that serve runtime services.</li> </ul> </li> <li> <strong>Intel SGX SDK</strong> Contains libraries and tools that is used to develop SGX applications. <ul> <li>The library is divided into 3 functional components (<a href="https://community.intel.com/t5/Intel-Software-Guard-Extensions/what-difference-on-sgx-psw-and-sgx-sdk/m-p/1134047#M1997" rel="external nofollow noopener" target="_blank">1</a>): <ul> <li> <strong>Trusted RunTime System (TRTS)</strong> is linked with the user enclave code</li> <li> <strong>Untrusted RunTime System (URTS)</strong> is linked with the untrusted part of the application that set up the enclave application by communicating with the <code class="language-plaintext highlighter-rouge">aesm_service</code> through sockets and pipes.</li> <li>The <strong>Enclave standard library</strong> provides minimal standard C/C++ functionalities (except for I/O related tasks)</li> </ul> </li> <li>THe SDK also provides utility for building and distributing enclaves: <ul> <li> <code class="language-plaintext highlighter-rouge">Edger8r</code> converts EDL files into actual interface implementation.</li> <li> <code class="language-plaintext highlighter-rouge">sgx_sign</code> signs enclave binaries</li> <li> <code class="language-plaintext highlighter-rouge">sgx-gdb</code> allows debugging of enclaves</li> </ul> </li> </ul> </li> <li> <strong>sgx-ssl</strong> is a port of OpenSSL to be executed inside SGX enclaves, which provide cryptographic primitives to enclaves, e.g., for key signing.</li> <li> <strong>DCAP (Data Center Attestation Primitives)</strong> provides two main libraries which are important in remote attestation. <ul> <li> <strong>Quote generation</strong> allows an enclave to generate a <em>quote</em>, which includes the measurement (hash) of its initial state.</li> <li> <strong>Quote verification</strong> enable a remove verifier to verify a generated <em>quote</em>.</li> </ul> </li> </ul> <h2 id="interactions">Interactions</h2> <p>Below are my attempts at providing an overview of how the software components interact with each other. Generally, the development stages of an enclave application can be classified into <em>build time</em> and <em>deployment time</em>.</p> <p>The diagrams contain all the components (and subcomponents) that were mentioned above. Note that this is heavily simplified, and may be also incorrect, as it reflect my current understanding.</p> <h3 id="build-time">Build time</h3> <p>The goal of building phase is to compile the source files of the enclave and the untrusted application, and an specification for the interface between them written in Enclave Definition Language (EDL). The output are (1) a signed enclave ELF and (2) the untrusted application, which is a normal ELF file.</p> <p><img src="/assets/img/sgx-build.png" alt="build" width="700"></p> <h3 id="deployment-time">Deployment time</h3> <p>To deploy an enclave, the untrusted part of the enclave application communicate with <code class="language-plaintext highlighter-rouge">aesm_service</code> to create and initialize the enclave.</p> <p><img src="/assets/img/sgx-deployment.png" alt="build" width="700"></p> <h2 id="distribution">Distribution</h2> <p>Intel provides a prebuilt version for most components, so the users don’t have to rebuild them from scratch. They can be accessed at <a href="https://download.01.org/intel-sgx/latest/linux-latest/" rel="external nofollow noopener" target="_blank">https://download.01.org/intel-sgx/latest/linux-latest/</a></p> <p>The driver for SGX is built into most modern Linux distribution (since Linux 5.11 <a href="https://gramine.readthedocs.io/en/stable/sgx-intro.html" rel="external nofollow noopener" target="_blank">3</a>), so manually installing them is not encouraged.</p> </div> </article><div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"kha-dinh/kha-dinh.github.io","data-repo-id":"","data-category":"Comments","data-category-id":"","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Kha Dinh Duy. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>